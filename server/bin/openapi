#!/usr/bin/env ruby
require "pathname"
ENV["BUNDLE_GEMFILE"] ||= File.expand_path("../../Gemfile",
                                           Pathname.new(__FILE__).realpath)

bundle_binstub = File.expand_path("bundle", __dir__)

if File.file?(bundle_binstub)
  if /This file was generated by Bundler/.match?(File.read(bundle_binstub, 300))
    load(bundle_binstub)
  else
    abort("Your `bin/bundle` was not generated by Bundler, so this binstub cannot run.
Replace `bin/bundle` by running `bundle binstubs bundler --force`, then run this command again.")
  end
end

require "rubygems"
require "bundler/setup"
require "yaml"
require "json_refs"

index = YAML.load_file("docs/openapi/index.yml")
document = JsonRefs.call(index)

File.open("docs/openapi/schema.json", "w") do |io|
  io.write(JSON.pretty_generate(document))
end

File.open("docs/openapi/schema.yml", "w") do |io|
  io.write(YAML.dump(document))
end
